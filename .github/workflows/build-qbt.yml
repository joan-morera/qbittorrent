name: Build qBittorrent Multi-Arch

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write
  packages: write

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      new_version_detected: ${{ steps.check.outputs.new_version_detected }}
      # Latest Versions
      qbt_ver: ${{ steps.get_qbt.outputs.tag }}
      libt_ver: ${{ steps.get_libt.outputs.tag }}
      qt_ver: ${{ steps.get_qt.outputs.tag }}
      boost_ver: ${{ steps.get_boost.outputs.tag }}
      ssl_ver: ${{ steps.get_ssl.outputs.tag }}
      mimalloc_ver: ${{ steps.get_mimalloc.outputs.tag }}
      distroless_digest: ${{ steps.get_distroless.outputs.digest }}
      
    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 1. Fetch Latest Versions
      # -----------------------------------------------------------------------
      
      # qBittorrent Release (Latest)
      - name: Get latest qBittorrent
        id: get_qbt
        run: |
          TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/qbittorrent/qBittorrent.git \
            | grep "refs/tags/release-" | grep -v "rc\|beta\|alpha" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Libtorrent v1.2 (Stable Branch)
      - name: Get latest Libtorrent v1
        id: get_libt
        run: |
          TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/arvidn/libtorrent.git \
            | grep "refs/tags/v1.2" | grep -v "RC" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Qt 6 (Latest Release)
      - name: Get latest Qt 6
        id: get_qt
        run: |
           # List remote tags and filter for v[0-9].
           TAG=$(git ls-remote --tags --sort='v:refname' https://code.qt.io/qt/qtbase.git \
             | grep -E "refs/tags/v[0-9]+\." | grep -v "beta\|rc\|alpha" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
           echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Boost (boost-1.86.0)
      - name: Get latest Boost
        id: get_boost
        run: |
          TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/boostorg/boost.git \
             | grep "refs/tags/boost-1.86" | grep -v "beta\|rc\|alpha" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # OpenSSL 3 (openssl-3.x.x)
      - name: Get latest OpenSSL 3
        id: get_ssl
        run: |
           TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/openssl/openssl.git \
             | grep "refs/tags/openssl-3" | grep -v "beta\|alpha" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
           echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Mimalloc (v3.x.x)
      - name: Get latest Mimalloc
        id: get_mimalloc
        run: |
           TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/microsoft/mimalloc.git \
             | grep "refs/tags/v" | grep -v "beta" | grep -v "\^{}" | tail -n1 | sed 's/.*\///' | sed 's/\^{}//')
           echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Distroless Digest
      - name: Get Distroless Digest
        id: get_distroless
        run: |
          DIGEST=$(docker manifest inspect gcr.io/distroless/cc-debian13:latest | jq -r '.manifests[0].digest')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
      
      # -----------------------------------------------------------------------
      # 2. Compare with Stored
      # -----------------------------------------------------------------------
      - name: Check for Changes
        id: check
        run: |
            FILE="package-versions.txt"
            CHANGED=false
            
               check_ver() {
                  NAME=$1
                  NEW=$2
                  # Strip package name from NEW if present (e.g. boost-1.86 -> 1.86) to match OLD format
                  if [[ "$NEW" == "${NAME}-"* ]]; then
                    NEW_Clean=${NEW#${NAME}-}
                  else
                    NEW_Clean=$NEW
                  fi
                  
                  OLD=$(grep "^${NAME}-" $FILE | cut -d- -f2- || echo "")
                  
                  if [ "$NEW_Clean" != "$OLD" ]; then
                     echo "NEW $NAME: $NEW (was $OLD)"
                     return 0
                  fi
                  return 1
               }

            if check_ver "qbittorrent" "${{ steps.get_qbt.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "libtorrent" "${{ steps.get_libt.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "qt" "${{ steps.get_qt.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "boost" "${{ steps.get_boost.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "openssl" "${{ steps.get_ssl.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "mimalloc" "${{ steps.get_mimalloc.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "distroless" "${{ steps.get_distroless.outputs.digest }}"; then CHANGED=true; fi

            echo "new_version_detected=$CHANGED" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # Build Generic Images (amd64, arm64)
  # ---------------------------------------------------------------------------
  build-generic:
    needs: check-versions
    if: needs.check-versions.outputs.new_version_detected == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
            suffix: amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            suffix: arm64
    runs-on: ${{ matrix.runner }}
    env:
      IMAGE_NAME: qbittorrent-rpi4 # Keeping name as requested for package continuity
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push (${{ matrix.suffix }})
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          # Generic Tags + "Latest" Strategy:
          # We tag each arch specific image.
          # We can't easily push a multi-arch "latest" manifest from separate matrix jobs without an extra merge step.
          # For simplicity in this structure: 
          # - we push :amd64 and :arm64
          # - we push :latest (on both) which effectively makes "latest" point to whichever pushed last (NOT IDEAL).
          # BETTER STRATEGY taken from alfis-docker reference:
          # Just push the specific tag here. We will use a separate job to manifest them if needed, 
          # BUT user requested: "latest, amd64 and arm64 tags all together".
          # To do "all together" correctly with manifest list, we should use a single job with platforms: linux/amd64,linux/arm64
          # EXCEPT we need different runners for native speed.
          # So we adhere to: Push :amd64, :arm64.
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ matrix.suffix }}
          build-args: |
             QBITTORRENT_VERSION=${{ needs.check-versions.outputs.qbt_ver }}
             LIBTORRENT_VERSION=${{ needs.check-versions.outputs.libt_ver }}
             QT_VERSION=${{ needs.check-versions.outputs.qt_ver }}
             BOOST_VERSION=${{ needs.check-versions.outputs.boost_ver }}
             OPENSSL_VERSION=${{ needs.check-versions.outputs.ssl_ver }}
             MIMALLOC_VERSION=${{ needs.check-versions.outputs.mimalloc_ver }}
             # Generic Optimization Flags (Safe for all CPUs)
             CFLAGS=-O3 -fstack-protector-strong -D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security
             CXXFLAGS=-O3 -fstack-protector-strong -D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security -flto
             LDFLAGS=-Wl,-z,relro -Wl,-z,now -flto
          platforms: ${{ matrix.platform }}
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Build Optimized RPi4 Image
  # ---------------------------------------------------------------------------
  build-rpi4:
    needs: check-versions
    if: needs.check-versions.outputs.new_version_detected == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04-arm
    env:
      IMAGE_NAME: qbittorrent-rpi4
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push (RPi4 Optimized)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:rpi4
          build-args: |
             QBITTORRENT_VERSION=${{ needs.check-versions.outputs.qbt_ver }}
             LIBTORRENT_VERSION=${{ needs.check-versions.outputs.libt_ver }}
             QT_VERSION=${{ needs.check-versions.outputs.qt_ver }}
             BOOST_VERSION=${{ needs.check-versions.outputs.boost_ver }}
             OPENSSL_VERSION=${{ needs.check-versions.outputs.ssl_ver }}
             MIMALLOC_VERSION=${{ needs.check-versions.outputs.mimalloc_ver }}
             # RPi4 Specific Optimization Flags
             CFLAGS=-O3 -mcpu=cortex-a72 -mtune=cortex-a72 -mno-outline-atomics -fstack-protector-strong -D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security
             CXXFLAGS=-O3 -mcpu=cortex-a72 -mtune=cortex-a72 -mno-outline-atomics -fstack-protector-strong -D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security -flto
             LDFLAGS=-Wl,-z,relro -Wl,-z,now -flto
          platforms: linux/arm64
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Create Manifest for Generic 'latest'
  # ---------------------------------------------------------------------------
  merge-manifest:
    needs: build-generic
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create and Push Manifest
        run: |
           IMAGE="ghcr.io/${{ github.repository_owner }}/qbittorrent-rpi4"
           docker buildx imagetools create -t $IMAGE:latest \
             $IMAGE:amd64 \
             $IMAGE:arm64

  # ---------------------------------------------------------------------------
  # Update Git Versions
  # ---------------------------------------------------------------------------
  update-repo:
      needs: [check-versions, build-generic, build-rpi4] # Wait for all builds
      if: always() && needs.check-versions.outputs.new_version_detected == 'true'
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - name: Update versions file
          run: |
             FILE="package-versions.txt"
             echo "# Main Application Versions" > $FILE
             echo "qbittorrent-${{ needs.check-versions.outputs.qbt_ver }}" >> $FILE
             echo "libtorrent-${{ needs.check-versions.outputs.libt_ver }}" >> $FILE
             echo "qt-${{ needs.check-versions.outputs.qt_ver }}" >> $FILE
             echo "${{ needs.check-versions.outputs.boost_ver }}" >> $FILE
             echo "${{ needs.check-versions.outputs.ssl_ver }}" >> $FILE
             echo "mimalloc-${{ needs.check-versions.outputs.mimalloc_ver }}" >> $FILE
             echo "distroless-${{ needs.check-versions.outputs.distroless_digest }}" >> $FILE
             
             git config --global user.name 'github-actions[bot]'
             git config --global user.email 'github-actions[bot]@users.noreply.github.com'
             git add $FILE
             if ! git diff --staged --quiet; then
                git commit -m "build(qbt): Update versions"
                git push
             fi
