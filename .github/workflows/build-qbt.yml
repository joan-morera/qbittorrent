name: Build qBittorrent RPi4 (Static)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write
  packages: write

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      new_version_detected: ${{ steps.check.outputs.new_version_detected }}
      # Latest Versions
      qbt_ver: ${{ steps.get_qbt.outputs.tag }}
      libt_ver: ${{ steps.get_libt.outputs.tag }}
      qt_ver: ${{ steps.get_qt.outputs.tag }}
      boost_ver: ${{ steps.get_boost.outputs.tag }}
      ssl_ver: ${{ steps.get_ssl.outputs.tag }}
      mimalloc_ver: ${{ steps.get_mimalloc.outputs.tag }}
      distroless_digest: ${{ steps.get_distroless.outputs.digest }}
      
    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 1. Fetch Latest Versions
      # -----------------------------------------------------------------------
      
      # qBittorrent Release (Latest)
      - name: Get latest qBittorrent
        id: get_qbt
        run: |
          TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/qbittorrent/qBittorrent.git \
            | grep "refs/tags/release-" | grep -v "rc\|beta\|alpha" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Libtorrent v1.2 (Stable Branch)
      - name: Get latest Libtorrent v1
        id: get_libt
        run: |
          TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/arvidn/libtorrent.git \
            | grep "refs/tags/v1.2" | grep -v "RC" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Qt 6 (Latest Release)
      - name: Get latest Qt 6
        id: get_qt
        run: |
           # List remote tags and filter for v[0-9].
           TAG=$(git ls-remote --tags --sort='v:refname' https://code.qt.io/qt/qtbase.git \
             | grep -E "refs/tags/v[0-9]+\." | grep -v "beta\|rc\|alpha" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
           echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Boost (boost-1.86.0)
      - name: Get latest Boost
        id: get_boost
        run: |
          TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/boostorg/boost.git \
             | grep "refs/tags/boost-1.86" | grep -v "beta\|rc\|alpha" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # OpenSSL 3 (openssl-3.x.x)
      - name: Get latest OpenSSL 3
        id: get_ssl
        run: |
           TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/openssl/openssl.git \
             | grep "refs/tags/openssl-3" | grep -v "beta\|alpha" | grep -v "\^{}" | tail -n1 | sed 's/.*\///')
           echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Mimalloc (v3.x.x)
      - name: Get latest Mimalloc
        id: get_mimalloc
        run: |
           TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/microsoft/mimalloc.git \
             | grep "refs/tags/v" | grep -v "beta" | grep -v "\^{}" | tail -n1 | sed 's/.*\///' | sed 's/\^{}//')
           echo "tag=${TAG}" >> $GITHUB_OUTPUT

      # Distroless Digest
      - name: Get Distroless Digest
        id: get_distroless
        run: |
          DIGEST=$(docker manifest inspect gcr.io/distroless/cc-debian13:latest | jq -r '.manifests[0].digest')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
      
      # -----------------------------------------------------------------------
      # 2. Compare with Stored
      # -----------------------------------------------------------------------
      - name: Check for Changes
        id: check
        run: |
            FILE="package-versions.txt"
            CHANGED=false
            
               check_ver() {
                  NAME=$1
                  NEW=$2
                  # Strip package name from NEW if present (e.g. boost-1.86 -> 1.86) to match OLD format
                  if [[ "$NEW" == "${NAME}-"* ]]; then
                    NEW_Clean=${NEW#${NAME}-}
                  else
                    NEW_Clean=$NEW
                  fi
                  
                  OLD=$(grep "^${NAME}-" $FILE | cut -d- -f2- || echo "")
                  
                  if [ "$NEW_Clean" != "$OLD" ]; then
                     echo "NEW $NAME: $NEW (was $OLD)"
                     return 0
                  fi
                  return 1
               }

            if check_ver "qbittorrent" "${{ steps.get_qbt.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "libtorrent" "${{ steps.get_libt.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "qt" "${{ steps.get_qt.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "boost" "${{ steps.get_boost.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "openssl" "${{ steps.get_ssl.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "mimalloc" "${{ steps.get_mimalloc.outputs.tag }}"; then CHANGED=true; fi
            if check_ver "distroless" "${{ steps.get_distroless.outputs.digest }}"; then CHANGED=true; fi

            echo "new_version_detected=$CHANGED" >> $GITHUB_OUTPUT

  build:
    needs: check-versions
    if: needs.check-versions.outputs.new_version_detected == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04-arm # ARM64 Runner
    env:
      IMAGE_NAME: qbittorrent-rpi4
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          build-args: |
             QBITTORRENT_VERSION=${{ needs.check-versions.outputs.qbt_ver }}
             LIBTORRENT_VERSION=${{ needs.check-versions.outputs.libt_ver }}
             QT_VERSION=${{ needs.check-versions.outputs.qt_ver }}
             BOOST_VERSION=${{ needs.check-versions.outputs.boost_ver }}
             OPENSSL_VERSION=${{ needs.check-versions.outputs.ssl_ver }}
             MIMALLOC_VERSION=${{ needs.check-versions.outputs.mimalloc_ver }}
          platforms: linux/arm64
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update versions file
        run: |
           FILE="package-versions.txt"
           echo "# Main Application Versions" > $FILE
           echo "qbittorrent-${{ needs.check-versions.outputs.qbt_ver }}" >> $FILE
           echo "libtorrent-${{ needs.check-versions.outputs.libt_ver }}" >> $FILE
           echo "qt-${{ needs.check-versions.outputs.qt_ver }}" >> $FILE
           echo "${{ needs.check-versions.outputs.boost_ver }}" >> $FILE
           echo "${{ needs.check-versions.outputs.ssl_ver }}" >> $FILE
           echo "mimalloc-${{ needs.check-versions.outputs.mimalloc_ver }}" >> $FILE
           echo "distroless-${{ needs.check-versions.outputs.distroless_digest }}" >> $FILE
           
           git config --global user.name 'github-actions[bot]'
           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
           git add $FILE
           if ! git diff --staged --quiet; then
              git commit -m "build(qbt): Update versions"
              git push
           fi
